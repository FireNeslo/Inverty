"use strict";angular.module("InvertyApp",[]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/high_score",{templateUrl:"views/high_score.html",controller:"HighScoreCtrl"}).when("/game_over",{templateUrl:"views/game_over.html",controller:"GameOverCtrl"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("InvertyApp").controller("GameCtrl",["$scope","$location","Inverty","highscore",function(a,b,c,d){var e=new c;a.stats=e.stats(),a.problem=e.problem(),a.solution=e.solution(),a.click=e.play(function(a){d.score(a),b.path("/game_over")}),a.report=function(){}}]),angular.module("InvertyApp").controller("HighScoreCtrl",["$scope","highscore",function(a,b){a.table=b.table}]),angular.module("InvertyApp").controller("GameOverCtrl",["$scope","$location","highscore",function(a,b,c){a.confirm=function(){c.save(a.player),b.path("high_score")}}]),angular.module("InvertyApp").controller("AboutCtrl",["$scope","$location","intyModels",function(a,b,c){var d=c.Grid,e=c.Rect;a.grid=new d([[!0,!1,!1,!1],[!1,!0,!0,!1],[!1,!1,!1,!0],[!1,!1,!1,!0]]),a.invert=function(b){a.grid.invert(e.rectFromPoint(b.x,b.y))},a.close=function(){b.path("/")}}]),angular.module("InvertyApp").directive("board",["intyModels",function(a){return{template:'<div style="width:{{width}}px;height:{{height}}px" class="span6"><ul ng-repeat="(y,bools) in grid.table" class="unstyled"><li style="width:{{colWidth}}px; height:{{colHeight}}px" ng-repeat="(x,b) in bools" ng-click="click(x,y)" ng-mouseleave="unhover(x,y)" ng-mouseover="hover(x,y)" class="pull-left tile tile-{{b}}"><div class="tile-inner t-{{x}}-{{y}}"></div></li></ul></div>',restrict:"E",replace:!0,scope:{grid:"=",width:"@",height:"@",disableInvert:"@",select:"=",onInvert:"=",highlight:"="},link:function(b,c){function d(a){var d,f;a?(d=a.x,f=a.y,b.grid.forRange(g.rectFromPoint(d,f),function(a,b){e(c).find(".t"+a+"-"+b).addClass("badness")}),b.last=a):b.last&&(d=b.last.x,f=b.last.y,b.grid.forRange(g.rectFromPoint(d,f),function(){e(c).find(".badness").removeClass("badness")}))}var e=window.jQuery,f=a.Grid,g=a.Rect,h=a.Point,i=!0;b.Grid=f,b.$watch("disableInvert",function(a){i="true"!==a}),b.hover=function(a,d){i&&b.grid.forRange(g.rectFromPoint(a,d),function(a,b){e(c).find(".t-"+a+"-"+b).addClass("highlight")})},b.$watch("highlight",d),b.unhover=function(a,d){i&&b.grid.forRange(g.rectFromPoint(a,d),function(){e(c).find(".highlight").removeClass("highlight")})},b.$watch("width",function(a){var c=parseInt(a,!1);b.colWidth=Math.floor(a/b.grid.width()),b.colHeight=Math.floor(c/b.grid.height())}),b.$watch("grid",function(a){var c=b.width||b.height||600,d=b.height||c;b.width=c,b.height=d,angular.isArray(a)&&(b.grid=new f(a),a=b.grid),b.colWidth=Math.floor(c/a.width()),b.colHeight=Math.floor(d/a.height())}),b.click=function(a,c){i&&(b.grid.invert(g.rectFromPoint(a,c)),b.onInvert&&b.onInvert(new h(a,c)))}}}}]),angular.module("InvertyApp").factory("intyModels",function(){function a(a,b){this.x=a||0,this.y=b||0}function b(a,b,c,d){angular.isNumber(a)?(this.xmin=a,this.xmax=b,this.ymin=c,this.ymax=d):(this.xmin=a.xmin,this.xmax=a.xmax,this.ymin=a.ymin,this.ymax=a.ymax)}function c(a,c){this.props=[],this.getRange=function(a){if(!a)throw new Error("No table error.");if(!a[0])throw new Error("Dimension error.");return new b(0,a[0].length,0,a.length)},angular.isNumber(a)?this.generate(a,c):angular.isArray(a)&&(this.table=a),this.range=this.getRange(this.table)}return a.prototype.x=null,a.prototype.y=null,a.prototype.add=function(b){return new a(this.x+b.x,this.y+b.y)},a.prototype.clone=function(){return new a(this.x,this.y)},a.prototype.degreesTo=function(a){var b=this.x-a.x,c=this.y-a.y,d=Math.atan2(c,b);return d*(180/Math.PI)},a.prototype.distance=function(a){var b=this.x-a.x,c=this.y-a.y;return Math.sqrt(b*b+c*c)},a.prototype.equals=function(a){return this.x===a.x&&this.y===a.y},a.prototype.interpolate=function(b,c){return new a((this.x+b.x)*c,(this.y+b.y)*c)},a.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},a.prototype.normalize=function(a){var b=this.length();this.x=this.x/b*a,this.y=this.y/b*a},a.prototype.orbit=function(a,b,c,d){var e=d*(Math.PI/180);this.x=a.x+b*Math.cos(e),this.y=a.y+c*Math.sin(e)},a.prototype.offset=function(a,b){this.x+=a,this.y+=b},a.prototype.subtract=function(b){return new a(this.x-b.x,this.y-b.y)},a.prototype.toString=function(){return"(x="+this.x+", y="+this.y+")"},a.interpolate=function(b,c,d){return new a((b.x+c.x)*d,(b.y+c.y)*d)},a.polar=function(b,c){return new a(b*Math.sin(c),b*Math.cos(c))},a.distance=function(a,b){var c=a.x-b.x,d=a.y-b.y;return Math.sqrt(c*c+d*d)},b.prototype.height=function(){return this.ymax-this.ymin},b.rectFromPoint=function(a,c,d,e){var f=d||3,g=e||3,h=a-Math.floor(f/2),i=h+f,j=c-Math.floor(g/2),k=j+g;return new b(h,i,j,k)},b.prototype.width=function(){return this.xmax-this.xmin},b.prototype.hitTest=function(a,b){return a>=this.xmin&&a<this.xmax&&b>=this.ymin&&b<this.ymax},c.prototype.generate=function(a,b){this.table=new Array(b);for(var c=0;b>c;c++){this.table[c]=new Array(b);for(var d=0;a>d;d++)this.table[c][d]=!!Math.floor(2*Math.random())}this.range=this.getRange(this.table)},c.prototype.copy=function(){for(var a=new Array(this.height()),b=0;b<this.table.length;b++)a[b]=angular.copy(this.table[b]);return new c(a)},c.prototype.equals=function(a){var b=!0,c=this;return this.forRange(this.range,function(d,e){c.get(d,e)!==a.get(d,e)&&(b=!1)}),b},c.prototype.width=function(){return this.range.width()},c.prototype.height=function(){return this.range.height()},c.prototype.hitTest=function(a,b){return this.range.hitTest(a,b)},c.prototype.get=function(a,b){return this.hitTest(a,b)?this.table[b][a]:!1},c.prototype.set=function(a,b,c){return this.hitTest(a,b)?(this.table[b][a]=c,!0):!1},c.prototype.forRange=function(a,b){for(var c=a.ymin;c<a.ymax;c++)for(var d=a.xmin;d<a.xmax;d++)b(d,c,this.get(d,c))},c.prototype.invert=function(a){a=a||this.range;var b=this;this.forRange(a,function(a,c,d){b.set(a,c,!d)})},c.prototype.setProp=function(a,b,c,d){this.props[b]=this.props[b]||[],this.props[b][a]=this.props[b][a]||{},this.props[b][a][c]=d},c.prototype.getProps=function(a,b){return this.props[b]&&this.props[b][a]?this.props[b][a]:(this.props[b][a]={},this.props[b][a])},c.prototype.getProp=function(a,b,c){return this.getProps(a,b)[c]},{Grid:c,Rect:b,Point:a}}),angular.module("InvertyApp").factory("Inverty",["intyModels",function(a){function b(){function a(a,b,c,d){this.lives=a||3,this.step=b||0,this.level=c||1,this.score=d||0,this.steps=[]}return a.prototype.levelUp=function(a){this.score+=100*(a.steps/this.lives)+100*this.level,this.level+=1,this.step=0,this.clearSteps(),a.next(this)},a.prototype.isDead=function(){return this.lives<1},a.prototype.lifeLost=function(){return this.lives-=1,this.isDead()},a.prototype.stats=function(){return{score:this.score,level:this.level}},a.prototype.clearSteps=function(){this.steps.length=0},a.prototype.nextStep=function(a,b,c){var d=this;if(this.step+=1,this.steps.push(b),this.step>=a.steps){this.step=0;var e=this.lifeLost();return e||a.hasWon()?d.clearSteps():c(function(b,c){return!a.test(b,c)}).then(function(){a.reset(d.steps),d.clearSteps()}),e}return!1},a}function c(){function a(a,b){this.size=a||4,this.sreps=b||1,this.newRound(this.size,this.steps)}return a.prototype.newRound=function(a,b){this.size=a||4,this.steps=b||1,this.solution=new e(this.size,this.size),this.problem=this.makeProblem(this.solution,this.steps)},a.prototype.makeProblem=function(a,b){a=a||this.solution,b=b||1;for(var c=a.copy(),d=0;b>d;d++){var e=Math.floor(Math.random()*c.width()),g=Math.floor(Math.random()*c.height());c.invert(f.rectFromPoint(e,g))}return c},a.prototype.test=function(a,b){return this.problem.get(a,b)===this.solution.get(a,b)},a.prototype.reset=function(a,b){b=b||this.problem;for(var c=a.length-1;c>=0;c--){var d=a[c];b.invert(f.rectFromPoint(d.x,d.y))}},a.prototype.hasWon=function(){return this.problem.equals(this.solution)},a.prototype.next=function(){this.steps+=1,this.steps>Math.floor(this.size/6)+2&&(this.size+=1,this.steps=1),this.newRound(this.size,this.steps)},a}function d(){function a(a,b,c,d){this.newGame(a,b,c,d)}var d=c(),e=b();return a.prototype.newGame=function(a,b,c,f,h){a=a||4,b=b||1,this.player=f||new e,this.round=h||new d(a,b),this.select=c||new g(3,3)},a.prototype.hasWon=function(){return this.round.hasWon()},a.prototype.nextStep=function(a,b){return this.player.nextStep(this.round,a,b)},a.prototype.play=function(a){var b=this;return function(c,d){var e=f.rectFromPoint(c.x,c.y,b.select.x,b.select.y);b.round.problem.invert(e),b.hasWon()?d(function(){return!0},"success").then(function(){b.player.levelUp(b.round)}):b.nextStep(c,d)&&(a&&a(b.player.stats()),b.newGame())}},a.prototype.problem=function(){var a=this;return function(){return a.round.problem}},a.prototype.solution=function(){var a=this;return function(){return a.round.solution}},a.prototype.stats=function(){var a=this;return function(){return{level:a.player.level,lives:a.player.lives,steps:a.round.steps}}},a}var e=a.Grid,f=a.Rect,g=a.Point;return d()}]),angular.module("InvertyApp").factory("highscore",["$q",function(a){var b,c=window.chrome,d={get:function(b,d){var e,f=a.defer();return c&&c.storage?(e={},e[b]=d,c.storage.local.get(e,function(a){console.log("chrome: ",a[b]),e=a[b],f.resolve(e)})):(e=window.localStorage.getItem(b),console.log("local: ",e),e=e?JSON.parse(e):d,f.resolve(e)),f.promise},set:function(a,b){var d;return c&&c.storage?(d={},d[a]=b,c.storage.local.set(d,function(){})):window.localStorage.setItem(a,b?JSON.stringify(b):""),b}};d.get("highscore",[]).then(function(a){b=a});var e=null;return{save:function(a){e&&(b.push({player:a,score:e}),d.set("highscore",b),e=null)},table:function(){return b},score:function(a){return a?(e=a,a):e}}}]),angular.module("InvertyApp").directive("intyBoard",["$q","$timeout","intyModels",function(a,b,c){return{template:'<div style="height:{{height}}px" class="{{wrapperClass}} inty-panel-wrapper"><div class="inty-panel"><ul ng-repeat="(y,bools) in grid.table" class="unstyled"><li style="width:{{colWidth}}%; height:{{height/(100/colHeight)}}px" ng-repeat="(x,b) in bools" ng-click="click(x,y)" ng-mouseleave="hover(x,y, false)" ng-mouseover="hover(x,y, true)" class="pull-left tile tile-{{b}}"><div class="tile-inner t-{{x}}-{{y}}"></div></li></ul><div class="clearfix"></div></div></div>',restrict:"E",replace:!0,scope:{grid:"=",disableInvert:"@",onClick:"=",highlight:"=",wrapperClass:"@"},link:function(d,e){function f(a,b){var c=0;d.grid.forRange(k.rectFromPoint(a,b),function(a,b){var d=i(e).find(".t-"+a+"-"+b)[0];d&&d.classList.add("highlight"),n[c]=d,c+=1})}function g(){for(var a=0;a<n.length;a++){var b=n[a];b&&b.classList.remove("highlight")}}function h(){return function(c,f,g,h){function j(){var a=0;d.grid.forRange(d.grid.range,function(b,d){m[a]=i(e).find(".t-"+b+"-"+d)[0],m[a]&&(!c||c&&c(b,d))&&m[a].classList.add(f),a+=1}),b(k,g)}function k(){angular.forEach(m,function(a,b){m[b]&&a.classList.remove(f)}),h>0?(h-=1,b(j,g)):d.$apply(function(){l.resolve(!0)})}f=f||"badness",h=h||2,g=(g||1e3)/h;var l=a.defer(),m=[];return j(),l.promise}}var i=window.jQuery,j=c.Grid,k=c.Rect,l=c.Point,m=!0;d.wrapperClass=d.wrapperClass||"span6",d.width=function(){return.95*i(e).width()},d.$watch(d.width,function(a){d.height=a}),window.resize=function(){d.$apply()},d.$watch("disableInvert",function(a){m="true"!==a}),d.$watch("grid",function(a){angular.isArray(a)&&(d.grid=new j(a),a=d.grid),d.colWidth=Math.floor(100/a.width()),d.colHeight=Math.floor(100/a.height())}),d.click=function(a,b){d.onClick&&d.onClick(new l(a,b),h())};var n=[];d.hover=function(a,b,c){m&&(c?f(a,b):g())}}}}]);

$(document).ready(function() {
  var manifest = location.href.replace(location.hash,"") + "manifest.webapp";
  if(navigator.mozApps) {
    var request = navigator.mozApps.getSelf();
    request.onsuccess = function() {
      if (!request.result) {
        var $navlist = $('.navbar-inverse .nav'),
            $navitem = $('<li></li>'),
            $navlink = $('<div id="webapp-install" class="pull-left btn">Install Webapp</div>');
        $navlink.click(function() {
          var req = navigator.mozApps.install(manifest);
          req.onsuccess = function() {
            $navlink.remove();
          };
          req.onerror = function(errObj) {
            $navlink.text("Not installed! Install?");
          };
        });
        $navitem.append($navlink);
        $navlist.append($navitem);
      }
    }
  }
});
